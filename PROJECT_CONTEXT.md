# Local Cafe App - 프로젝트 컨텍스트

## 프로젝트 개요
토스 미니앱에서 PWA로 전환하는 카페 스탬프 적립 시스템

## 최종 요구사항
1. **결제와 동시에 적립**: 사용자가 결제하면 자동으로 스탬프 적립
2. **사이렌오더**: 모바일 주문 지원
3. **가맹점 상황**: 옛날 POS기 + 스마트폰만 보유

---

## 핵심 기술 결정

### Wallet Pass - 제외
- Apple Wallet Pass 구현 완료했으나 스코프에서 제외
- 이유: 스탬프는 앱에서 관리하면 충분

### 결제 연동 - PortOne (PG)
- Apple Pay, Samsung Pay, Google Pay 등은 토큰화된 카드 결제일 뿐
- **제3자에게 결제 콜백 API 제공 안함**
- PG(PortOne)를 통해야만 결제 완료 웹훅 수신 가능

### 기존 VAN 단말기 - 연동 불가
- Smartro SMT-T266 같은 기존 VAN 단말기는 폐쇄 시스템
- 외부 서버와 연동 불가능
- 모든 결제는 우리 앱/PG를 통해야 함

---

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        고객 앱 (PWA)                              │
├─────────────────────────────────────────────────────────────────┤
│  - 회원가입/로그인                                                 │
│  - 사이렌오더 (메뉴 선택 → 결제)                                    │
│  - QR 결제 (매장 QR 스캔 → 결제)                                   │
│  - 스탬프 조회                                                    │
│  - 결제수단: Apple Pay, Samsung Pay, Google Pay, Kakao Pay 등      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        서버 (Next.js API)                        │
├─────────────────────────────────────────────────────────────────┤
│  - PortOne 결제 연동                                              │
│  - 결제 완료 웹훅 → 자동 스탬프 적립                                 │
│  - 주문 관리                                                      │
│  - 푸시 알림                                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      가맹점 앱 (PWA)                              │
├─────────────────────────────────────────────────────────────────┤
│  - 주문 알림 수신                                                 │
│  - QR 코드 표시 (고객이 스캔)                                      │
│  - 수동 결제 요청 (금액 입력 → 고객에게 푸시)                         │
│  - 주문 완료 처리                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 결제 시나리오

### 시나리오 1: 사이렌오더
```
1. 고객: 앱에서 메뉴 선택
2. 고객: 결제 (Apple Pay 등)
3. 서버: PortOne 웹훅 수신 → 자동 스탬프 적립
4. 가맹점: 주문 알림 수신
5. 가맹점: 음료 준비 → 완료 처리
6. 고객: 픽업 알림 수신
```

### 시나리오 2: 매장 QR 결제
```
1. 고객: 매장 방문, 주문
2. 가맹점: 금액 입력 → QR 코드 표시
3. 고객: QR 스캔 → 결제
4. 서버: PortOne 웹훅 수신 → 자동 스탬프 적립
5. 가맹점: 결제 완료 알림
```

### 시나리오 3: 푸시 결제 요청
```
1. 고객: 매장 방문, 주문
2. 가맹점: 금액 + 고객 전화번호 입력 → 결제 요청
3. 고객: 푸시 알림 → 결제
4. 서버: PortOne 웹훅 수신 → 자동 스탬프 적립
5. 가맹점: 결제 완료 알림
```

---

## 기술 스택

| 구분 | 기술 |
|------|------|
| Frontend | Next.js 14, React, TypeScript |
| Backend | Next.js API Routes |
| Database | Supabase (PostgreSQL) |
| 결제 | PortOne (구 아임포트) |
| 인증 | Supabase Auth |
| 배포 | Vercel (예정) |

---

## 환경 변수

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://ajqemwdukxmlyyuzcxdc.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...

# Apple (Wallet Pass용 - 현재 미사용)
APPLE_TEAM_ID=KC564L7GQ8
APPLE_PASS_TYPE_ID=pass.com.oli.localcafe

# PortOne (추가 예정)
PORTONE_API_KEY=
PORTONE_API_SECRET=
PORTONE_WEBHOOK_SECRET=
```

---

## DB 스키마 (현재)

```sql
-- 기존 테이블
users          -- 사용자
cafes          -- 카페/가맹점
stamps         -- 스탬프

-- 추가된 테이블 (Wallet Pass용 - 미사용 가능)
wallet_passes  -- Wallet Pass 정보
```

---

## 구현 우선순위

### Phase 1: MVP
1. [ ] PortOne 결제 연동
2. [ ] 결제 웹훅 → 자동 스탬프 적립
3. [ ] 사이렌오더 기본 기능
4. [ ] 가맹점 주문 알림

### Phase 2: 매장 결제
1. [ ] QR 결제
2. [ ] 푸시 결제 요청
3. [ ] 가맹점 앱 개선

### Phase 3: 고도화
1. [ ] 푸시 알림 (FCM)
2. [ ] 쿠폰/리워드 시스템
3. [ ] 통계/리포트

---

## 참고: 한국 결제 시장 현황 (2024)

- **간편결제 일평균**: 3,072만 건, 9,594억 원
- **한국 POS 시장**: $2.1B (2024) → $4.4B (2033), CAGR 7.5%
- **모바일 POS 성장 중**: PayHere, 토스프론트 등
- **소상공인 대부분**: 기존 VAN 단말기 사용 (연동 불가)

---

## 제외된 기능

- **Apple Wallet Pass**: 구현 완료했으나 스코프에서 제외
- **기존 POS 연동**: 기술적으로 불가능

---

*마지막 업데이트: 2025-12-30*
